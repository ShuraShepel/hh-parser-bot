import os
from parser import parse_hh_vacancy
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, ContextTypes, filters
from openai import OpenAI

client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
TELEGRAM_TOKEN = os.environ["TELEGRAM_TOKEN"]

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    chat_id = update.effective_chat.id

    if text.startswith("https://hh.ru/vacancy/"):
        await context.bot.send_message(chat_id=chat_id, text="–°—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞. –ü–∞—Ä—Å—é –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶")

        try:
            description = parse_hh_vacancy(text)
            if not description or "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏" in description:
                await context.bot.send_message(chat_id=chat_id, text="–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ üòû")
                return

            await context.bot.send_message(chat_id=chat_id, text="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ. –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ‚Ä¶")

            prompt = (
                "–ù–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∏–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å—Ç–∏–ª–µ:\n"
                "- –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ;\n"
                "- –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: –º–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä. –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞–∫–∞–Ω—Å–∏—è \"...\";\n"
                "- –±–ª–æ–∫: '–ú–æ–∏ –∫–ª—é—á–µ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ –∏ –∑–Ω–∞–Ω–∏—è, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤–∞—à–µ–π –≤–∞–∫–∞–Ω—Å–∏–∏:'\n"
                "- —Å–ø–∏—Å–æ–∫ –∏–∑ 7‚Äì10 –ø—É–Ω–∫—Ç–æ–≤ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –Ω–∞–≤—ã–∫–∞–º–∏ –∏ –æ–ø—ã—Ç–æ–º;\n"
                "- –∞–±–∑–∞—Ü —Å —Ñ—Ä–∞–∑–æ–π: '–ù–∞ –∏–Ω—Ç–µ—Ä–≤—å—é —Å —Ä–∞–¥–æ—Å—Ç—å—é —Ä–∞—Å—Å–∫–∞–∂—É –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ. –°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.'\n"
                "- –ø–æ–¥–ø–∏—Å—å: '–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä'.\n\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏:\n{description}"
            )

            response = client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.7
            )

            letter = response.choices[0].message.content.strip()

            # –ö–æ—Ä—Ä–µ–∫—Ü–∏–∏
            letter = letter.replace("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!!", "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!")
            letter = letter.replace(
                "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, –∏ —è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ –ø–æ–∑–∏—Ü–∏–∏ –°—Ç–∞—Ä—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ data-–ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ LaTech.",
                "–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å–∞–Ω–¥—Ä. –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞–∫–∞–Ω—Å–∏—è \"Project Manager (–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö)\"."
            )
            letter = letter.replace(
                "–ë—É–¥—É —Ä–∞–¥ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Å—É–¥–∏—Ç—å –º–æ–π –æ–ø—ã—Ç –∏ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é.",
                "–ù–∞ –∏–Ω—Ç–µ—Ä–≤—å—é —Å —Ä–∞–¥–æ—Å—Ç—å—é —Ä–∞—Å—Å–∫–∞–∂—É –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
            )
            letter = letter.replace(
                "–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –®–µ–ø–µ–ª–µ–≤.",
                "–ù–∞ –∏–Ω—Ç–µ—Ä–≤—å—é —Å —Ä–∞–¥–æ—Å—Ç—å—é —Ä–∞—Å—Å–∫–∞–∂—É –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
            )
            letter = letter.replace(
                "–Ø –≥–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å —Å–≤–æ–π –æ–ø—ã—Ç –∏ –≤–æ–∑–º–æ–∂–Ω—ã–π –≤–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é.",
                "–ù–∞ –∏–Ω—Ç–µ—Ä–≤—å—é —Å —Ä–∞–¥–æ—Å—Ç—å—é —Ä–∞—Å—Å–∫–∞–∂—É –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
            )
            letter = letter.replace(
                "–Ø –≥–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å –º–æ–π –æ–ø—ã—Ç –∏ –∫–∞–∫ —è –º–æ–≥—É –ø—Ä–∏–Ω–µ—Å—Ç–∏ –ø–æ–ª—å–∑—É –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ –Ω–∞ –∏–Ω—Ç–µ—Ä–≤—å—é.",
                "–ù–∞ –∏–Ω—Ç–µ—Ä–≤—å—é —Å —Ä–∞–¥–æ—Å—Ç—å—é —Ä–∞—Å—Å–∫–∞–∂—É –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ.\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä"
            )

            if len(letter) > 4000:
                letter = letter[:3990] + "\n\n(–æ–±—Ä–µ–∑–∞–Ω–æ)"

            await context.bot.send_message(chat_id=chat_id, text=letter)

        except Exception as e:
            await context.bot.send_message(chat_id=chat_id, text=f"–û—à–∏–±–∫–∞: {e}")

    else:
        await context.bot.send_message(chat_id=chat_id, text="–ü—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é —Å hh.ru")

if __name__ == '__main__':
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω üöÄ")
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), handle_message))
    app.run_polling()